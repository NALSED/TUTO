
# 

---

### 1️⃣ `Présentation`
### 2️⃣ `Utilisation`
### `COMMANDES`

---

### 1️⃣ **Présentation**

`[RAPPEL]` => VU dans la section [-5-Authentification](https://github.com/NALSED/TUTO/blob/main/PERSO/VAULT/FONCTIONNEMENT/-5-Authentification.md)
```
USER                    VAULT                    AUTH BACKEND
                                                  (LDAP/AD/GitHub/etc.)
│                       │                              │
│  1. Login request     │                              │
│  (username/password)  │                              │
│──────────────────────>│                              │
│                       │                              │
│                       │  2. Vérification identité    │
│                       │─────────────────────────────>│
│                       │                              │
│                       │  3. OK + groupes/infos       │
│                       │<─────────────────────────────│
│                       │                              │
│                       │  4. Mapping groupes          │
│                       │     → policies Vault         │
│                       │                              │
│  5. TOKEN + policies  │                              │
│<──────────────────────│                              │
│                       │                              │
│  6. Requêtes avec     │                              │
│     token             │                              │
│──────────────────────>│                              │
│                       │                              │
│  7. Secrets           │                              │
│   (si autorisé)       │                              │
│<──────────────────────│                              │
```

### **- Génération du Credential DB**
```
USER                    VAULT                         DATABASE
  │                       │                              │
  │  1. Demande secret    │                              │
  │  (path: db/creds/my-role)                            │
  │──────────────────────>│                              │
  │                       │                              │
  │                       │  2. Vérifie token            │
  │                       │     + policies ACL           │
  │                       │                              │
  │                       │  3. Génère credential        │
  │                       │─────────────────────────────>│
  │                       │                              │
  │                       │  4. Crée user + GRANT        │
  │                       │<─────────────────────────────│
  │                       │                              │
  │  5. login + password  │                              │
  │     + lease_id + TTL  │                              │
  │<──────────────────────│                              │
  │                       │                              │
  │  6. Connexion DB      │                              │
  │─────────────────────────────────────────────────────>│
  │                       │                              │
  │  7. Session active    │                              │
  │<─────────────────────────────────────────────────────│
```

### **- Résumé RENEW / ROTATION / REVOCATION**
```
USER                         VAULT                        DATABASE
  │                            │                              │
  │                            │                              │
  │   ┌────────────────────────┼──────────────────────────────┼───────────────────────┐
  │   │ RENEWAL                │                              │                       │
  │   │                        │                              │                       │
  │   │  renew-self ─────────> │  vérifie max_ttl             │                       │
  │   │  (avant expiration)    │  étend le lease              │                       │
  │   │  nouveau TTL <──────── │                              │                       │
  │   └────────────────────────┼──────────────────────────────┼───────────────────────┘
  │                            │                              │
  │                            │  ┌───────────────────────────┼───────────────────────┐
  │                            │  │ ROTATION                  │                       │
  │                            │  │                           │                       │
  │                            │  │  TTL expiré /             │                       │
  │                            │  │  rotation forcée          │                       │
  │                            │  │  génère nouveau ────────> │  update password      │
  │                            │  │  credential    <───────── │  confirmation         │
  │                            │  │  révoque ancien ────────> │  drop old creds       │
  │  nouveau lease_id <─────── │  │                           │                       │
  │  + new credentials         │  └───────────────────────────┼───────────────────────┘
  │                            │                              │
  │   ┌────────────────────────┼──────────────────────────────┼───────────────────────┐
  │   │ REVOCATION             │                              │                       │
  │   │                        │                              │                       │
  │   │  revoke ────────────>  │  invalide lease              │                       │
  │   │  (manuel / incident /  │  immédiatement ───────────>  │  DROP USER            │
  │   │   fin de vie)          │                  <─────────── │  REVOKE GRANT        │
  │   │                        │  purge secret                │                       │
  │   │                        │  + audit log                 │                       │
  │   │  accès refusé <─────── │                              │                       │
  │   └────────────────────────┼──────────────────────────────┼───────────────────────┘
  │                            │                              │
```

### -1. `Use case`

<img width="1126" height="838" alt="image" src="https://github.com/user-attachments/assets/b28149a6-52ce-4198-a59e-900d10f4f7bc" />

- Secret à la demande pour un usage bien précis

### -. `Possibilitées`

**Databases** (non exaustive)
| Engine | Cible |
|--------|-------|
| `database/postgresql` | PostgreSQL |
| `database/mysql` | MySQL / MariaDB |
| `database/mongodb` | MongoDB |
| `database/mssql` | SQL Server |
| `database/oracle` | Oracle DB |
| `database/cassandra` | Cassandra |
| `database/elasticsearch` | Elasticsearch |
| `database/redis` | Redis |
| `database/influxdb` | InfluxDB |

- Possibilité de `Custom` si DB absente

**Cloud**
| Engine | Cible |
|--------|-------|
| `aws` | IAM Access Keys / STS tokens |
| `azure` | Service Principal credentials |
| `gcp` | Service Account keys / OAuth tokens |

**Infrastructure**
| Engine | Cible |
|--------|-------|
| `pki` | Certificats TLS / x509 |
| `ssh` | Certificats SSH signés / OTP |
| `nomad` | Tokens Nomad |
| `consul` | Tokens Consul |

**Messaging & Middleware**
| Engine | Cible |
|--------|-------|
| `rabbitmq` | Users RabbitMQ |
| `activemq` | Users ActiveMQ |

**Identité & Accès**
| Engine | Cible |
|--------|-------|
| `kubernetes` | ServiceAccount tokens |
| `ldap` | Passwords LDAP / AD |
| `terraform` | Tokens Terraform Cloud |

### -2. `Concepts Clés`

| Concept | Rôle |
|---|---|
| **Engine** | Le connecteur vers la cible (DB, AWS, PKI…) |
| **Role** | L'orchestrateur — définit quoi créer, où, comment, combien de temps |
| **Credential** | Le résultat temporaire produit par le role |
| **Lease** | Le contrat de durée de vie du credential |

- **ROLE**

- `Dynamic`  Vault crée un credential temporaire unique à chaque demande, il s'autodétruit à l'expiration du TTL.  
- `Static`  Vault gère un credential existant et fixe dans la DB, il ne le crée pas — il se contente de faire tourner son mot de passe à intervalle régulier.



###-. ``

---
---

### 2️⃣ **Utilisation**




- Présentation d'utilisation de Dynamic Secret Engine:

### -1. **Database**

`[PREREQUIS]`
-Ici pour la présentation Utilisation de PostGreSQL
    - Installation via [script](https://github.com/NALSED/TUTO/blob/main/PERSO/SAUVEGARDE/BAREOS/INSTALLATION/SCRIPTS/-1-Install_PostGreSQP.sh)

- Pour la démonstration : Utilisateur PostgreSQL 'sednal'(uper-utilisateur pour PostgreSQL) et base 'sednal_base' 

- Par defaut PostGreSQL n'a de mot de passe pour aucun des User, nous allons le definir.

   - Se connecter avec l'utilisateur postgresql
```
sudo -i -u postgres
```
   


- 1.1 Activation database
```
vault secrets enable database
```


-
```

```

-
```

```



-
```

```



-
```

```
### -2. **PKI**

- 
```

```


-
```

```

-
```

```



-
```

```



-
```

```

### -3. SSH
---
---

### **COMMANDES**


``


-Sortie


---


``


-Sortie


---

``


-Sortie


---

``


-Sortie


---

``


-Sortie


---

``


-Sortie


---


 [CHOSES A RETENIR]
