
# Vault secret Engine dynamic

---

### 1️⃣ `Présentation`
### 2️⃣ `Utilisation`
### `COMMANDES`

---

### 1️⃣ **Présentation**

`[RAPPEL]` => VU dans la section [-5-Authentification](https://github.com/NALSED/TUTO/blob/main/PERSO/VAULT/FONCTIONNEMENT/-5-Authentification.md)
```
USER                    VAULT                    AUTH BACKEND
                                                  (LDAP/AD/GitHub/etc.)
│                       │                              │
│  1. Login request     │                              │
│  (username/password)  │                              │
│──────────────────────>│                              │
│                       │                              │
│                       │  2. Vérification identité    │
│                       │─────────────────────────────>│
│                       │                              │
│                       │  3. OK + groupes/infos       │
│                       │<─────────────────────────────│
│                       │                              │
│                       │  4. Mapping groupes          │
│                       │     → policies Vault         │
│                       │                              │
│  5. TOKEN + policies  │                              │
│<──────────────────────│                              │
│                       │                              │
│  6. Requêtes avec     │                              │
│     token             │                              │
│──────────────────────>│                              │
│                       │                              │
│  7. Secrets           │                              │
│   (si autorisé)       │                              │
│<──────────────────────│                              │
```

### **- Génération du Credential DB**

`[NOTE]` Ici, utilisation d’une DataBase pour l’exemple, mais flux universel entre Vault et App ou service.
```
USER                    VAULT                         DATABASE
  │                       │                              │
  │  1. Demande secret    │                              │
  │  (path: db/creds/my-role)                            │
  │──────────────────────>│                              │
  │                       │                              │
  │                       │  2. Vérifie token            │
  │                       │     + policies ACL           │
  │                       │                              │
  │                       │  3. Génère credential        │
  │                       │─────────────────────────────>│
  │                       │                              │
  │                       │  4. Crée user + GRANT        │
  │                       │<─────────────────────────────│
  │                       │                              │
  │  5. login + password  │                              │
  │     + lease_id + TTL  │                              │
  │<──────────────────────│                              │
  │                       │                              │
  │  6. Connexion DB      │                              │
  │─────────────────────────────────────────────────────>│
  │                       │                              │
  │  7. Session active    │                              │
  │<─────────────────────────────────────────────────────│
```

### **- Résumé RENEW / ROTATION / REVOCATION**
```
USER                         VAULT                        DATABASE
  │                            │                              │
  │                            │                              │
  │   ┌────────────────────────┼──────────────────────────────┼───────────────────────┐
  │   │ RENEWAL                │                              │                       │
  │   │                        │                              │                       │
  │   │  renew-self ─────────> │  vérifie max_ttl             │                       │
  │   │  (avant expiration)    │  étend le lease              │                       │
  │   │  nouveau TTL <──────── │                              │                       │
  │   └────────────────────────┼──────────────────────────────┼───────────────────────┘
  │                            │                              │
  │                            │  ┌───────────────────────────┼───────────────────────┐
  │                            │  │ ROTATION                  │                       │
  │                            │  │                           │                       │
  │                            │  │  TTL expiré /             │                       │
  │                            │  │  rotation forcée          │                       │
  │                            │  │  génère nouveau ────────> │  update password      │
  │                            │  │  credential    <───────── │  confirmation         │
  │                            │  │  révoque ancien ────────> │  drop old creds       │
  │  nouveau lease_id <─────── │  │                           │                       │
  │  + new credentials         │  └───────────────────────────┼───────────────────────┘
  │                            │                              │
  │   ┌────────────────────────┼──────────────────────────────┼───────────────────────┐
  │   │ REVOCATION             │                              │                       │
  │   │                        │                              │                       │
  │   │  revoke ────────────>  │  invalide lease              │                       │
  │   │  (manuel / incident /  │  immédiatement ───────────>  │  DROP USER            │
  │   │   fin de vie)          │                  <─────────── │  REVOKE GRANT        │
  │   │                        │  purge secret                │                       │
  │   │                        │  + audit log                 │                       │
  │   │  accès refusé <─────── │                              │                       │
  │   └────────────────────────┼──────────────────────────────┼───────────────────────┘
  │                            │                              │
```

### -1. `Use case`

<img width="1126" height="838" alt="image" src="https://github.com/user-attachments/assets/b28149a6-52ce-4198-a59e-900d10f4f7bc" />

- Secret à la demande pour un usage bien précis

### -2. `Cas d'usages de Vault`

- Les liste suivant sont non exaustives..

**Databases** (non exaustive)
| Engine | Cible |
|--------|-------|
| `database/postgresql` | PostgreSQL |
| `database/mysql` | MySQL / MariaDB |
| `database/mongodb` | MongoDB |
| `database/mssql` | SQL Server |
| `database/oracle` | Oracle DB |
| `database/cassandra` | Cassandra |
| `database/elasticsearch` | Elasticsearch |
| `database/redis` | Redis |
| `database/influxdb` | InfluxDB |

- Possibilité de `Custom` si DB absente

**Cloud** (non exaustive)
| Engine | Cible |
|--------|-------|
| `aws` | IAM Access Keys / STS tokens |
| `azure` | Service Principal credentials |
| `gcp` | Service Account keys / OAuth tokens |

**Infrastructure**
| Engine | Cible |
|--------|-------|
| `pki` | Certificats TLS / x509 |
| `ssh` | Certificats SSH signés / OTP |
| `nomad` | Tokens Nomad |
| `consul` | Tokens Consul |

**Messaging & Middleware**
| Engine | Cible |
|--------|-------|
| `rabbitmq` | Users RabbitMQ |
| `activemq` | Users ActiveMQ |

**Identité & Accès**
| Engine | Cible |
|--------|-------|
| `kubernetes` | ServiceAccount tokens |
| `ldap` | Passwords LDAP / AD |
| `terraform` | Tokens Terraform Cloud |

### -3. `Concepts Clés pour Vault secret Engine dynamic`

| Concept | Rôle |
|---|---|
| **Engine** | Le connecteur vers la cible (DB, AWS, PKI…) |
| **Role** | L'orchestrateur — définit quoi créer, où, comment, combien de temps |
| **Credential** | Le résultat temporaire produit par le role |
| **Lease** | Le contrat de durée de vie du credential |

- **ROLE**

- `Dynamic`  Vault crée un credential temporaire unique à chaque demande, il s'autodétruit à l'expiration du TTL.  
- `Static`  Vault gère un credential existant et fixe dans la DB, il ne le crée pas — il se contente de faire tourner son mot de passe à intervalle régulier.

---
---

### 2️⃣ **Utilisation**

---

⚠️ **[AVERTISSEMENT]**

- Environnement de Test — Ne pas utiliser en Production

 Ce tutoriel est réalisé dans un cadre **découverte et apprentissage**.
 Les configurations appliquées ici sont volontairement simplifiées et **ne respectent pas les bonnes pratiques de sécurité** requises en production.

 Notamment :
- Pas de chiffrement SSL/TLS sur les connexions PostgreSQL
- Pas de chiffrement SSL/TLS sur Vault
- Vault en configuration minimale
- Credentials et politiques non durcis
- Accès peer PostgreSQL non restreint
- Aucune séparation des environnements

 **Avant tout déploiement en production**, consulter :
 - [Vault Production Hardening](https://developer.hashicorp.com/vault/tutorials/operations/production-hardening)
 - [PostgreSQL SSL Configuration](https://www.postgresql.org/docs/current/ssl-tcp.html)

---

## Présentation d'utilisation d'un role `Dynamic` Secret Engine:

### -1. **Database**

`[PREREQUIS]`
- PostGreSQL
    - Installation via [script](https://github.com/NALSED/TUTO/blob/main/PERSO/SAUVEGARDE/BAREOS/INSTALLATION/SCRIPTS/-1-Install_PostGreSQP.sh)

- Pour la démonstration : Utilisateur PostgreSQL 'sednal'

`=>` Par défaut, PostgreSQL n’a aucun mot de passe défini pour ses utilisateurs, nous allons donc en configurer un :

`=>` Se connecter avec l'utilisateur `postgres`
```
sudo -i -u postgres
```

`=>` Ouvrir la console et créer password pour `postgres`
```
psql
ALTER USER postgres PASSWORD '131213';
```

`=>` Verifier le port
```
SHOW port;

port
------
 5432
(1 ligne)

```

---

`[RAPPEL]`
```
vault write  [engine]/[type]/[nom-libre]
                │        │        │
                │        │        └── Libre
                │        └─────────── Imposé par Vault (config, roles, creds)
                └──────────────────── Imposé par Vault (database, aws, pki…)
```

---

- 1.1 Activation database
```
vault secrets enable database
```


- 1.2 Configuration du Secret engine pour PostGreSQL
Ici => user : postgres / mdp : 131213 / port : 5432 / ssl désactivé / tous les rôles acceptés
```
vault write database/config/postgresql \
    plugin_name=postgresql-database-plugin \
    allowed_roles="*" \
    connection_url="postgresql://{{username}}:{{password}}@127.0.0.1:5432/postgres?sslmode=disable" \
    username="postgres" \
    password="131213"
```

`=>` Sortie
```
Success! Data written to: database/config/postgresql
```

- 1.3 rotation du mot de passe root (postgres, ici 131213)
```
vault write -force database/rotate-root/postgresql
```

---

### ⚠️ `[ATTENTION]` ⚠️ 

[DOC OFICIELLE Rotate_Root](https://developer.hashicorp.com/vault/tutorials/db-credentials/database-root-rotation#rotate-the-root-credentials)

- Ici Vault ne désactive pas l'accés via shell (peer toujours possible)

`[EXEMPLE]`
```
sudo -i -u postgres
postgres@VaultTraining:~$ psql -W

Mot de passe :

psql (18.2 (Debian 18.2-1.pgdg13+1))
Saisissez « help » pour l'aide.

postgres=#  <========== ICI connection possible via peer, le -W est ignoré, peer prend le dessus
postgres=# \q


postgres@VaultTraining:~$ psql -h localhost -p5432 -U root postgres

Mot de passe pour l'utilisateur root : <=======  Avec -h localhost => TCP/IP => peer impossible, mdp obligatoire

psql: erreur : la connexion au serveur sur « localhost » (::1), port 5432 a échoué : FATAL:  authentification par mot de passe échouée pour l'utilisateur  « root »
la connexion au serveur sur « localhost » (::1), port 5432 a échoué : FATAL:  authentification par mot de passe échouée pour l'utilisateur  « root »

postgres@VaultTraining:~$ exit
déconnexion
```

---

`[NOTE]` Ici le fichier se crée dans le dossier courant (Si plusieurs configuration/db/role, créer une arborescence pour ranger proprement les fichiers de configuration.)
- Ici
```
 vault-config
  ├── policies
  │   ├── apps
  │   └── user
  │       ├── policy_user_auth.hcl
  │       └── user_ldap.hcl
  ├── role
  │   └── readonly.sql <=======
  └── scripts
```

- 1.4 Ecriture un rôle, sous forme de requet SQL (ici utilisation de tee + EOF, mais édition via vim ou nano possible) 
   - Les `{{}}` sont des variables que Vault remplace à chaque génération de credential
   - Ce role => read only  
```
tee readonly.sql <<EOF
CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}' INHERIT;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO "{{name}}";
EOF
cat readonly.sql
```

- 1.5 Création du rôle dans vault
```
vault write database/roles/readonly \
      db_name=postgresql \
      creation_statements=@/home/sednal/vault-config/role/readonly.sql \
      default_ttl=1h \
      max_ttl=24h
```

`=>` Sortie
```
Success! Data written to: database/roles/readonly
```

- 1.6 Création d'un credential pour accéder à PostGreSQL (ici rôle dynamique donc à chaque exécution nouveaux credential)
```
vault read database/creds/readonly
```

`=>` Sortie
```
Key                Value
---                -----
lease_id           database/creds/readonly/9LnB6pIW8ZOCfUosxhC0RyAM
lease_duration     1h
lease_renewable    true
password           cTpjGJxOT2nBrqJYue-n
username           v-root-readonly-BqTUYtCjT0hYOiSVMtju-1771324290
```

- 1.7 Test Accés PostGreSQL
```
psql -h localhost -U v-root-readonly-BqTUYtCjT0hYOiSVMtju-1771324290 -W postgres
```

`=>` Sortie OK
```
sednal@VaultTraining:~$ psql -h localhost -U v-root-readonly-BqTUYtCjT0hYOiSVMtju-1771324290 -W postgres
Mot de passe :
psql (18.2 (Debian 18.2-1.pgdg13+1))
Connexion SSL (protocole : TLSv1.3, chiffrement : TLS_AES_256_GCM_SHA384, compression : désactivé, ALPN : postgresql)
Saisissez « help » pour l'aide.

postgres=>  <========= ICI connection OK 
```



**Pour administrer les leases**

- 1.8 voir le crédential avec secret (Il faut avoir les droits)
```
vault read database/creds/readonly

=>SORTIE

Key                Value
---                -----
lease_id           database/creds/readonly/bartV2mZhIaLO5eFvvqL9UVC
lease_duration     1h
lease_renewable    true
password           GK-n7jVV5HPPxh2ZTQ6U
username           v-root-readonly-xHC9giBo6qu0iv2tcnpb-1771325197
```

- 1.9 Voir les ID (use case = utiliser les ID pour renouvelement credetial sans voir le secret)
```
vault list sys/leases/lookup/database/creds/readonly

=> SORTIE ID

Keys
----
9LnB6pIW8ZOCfUosxhC0RyAM
bartV2mZhIaLO5eFvvqL9UVC

```

- 1.10 voir le lease du crédentialvia ID
```
vault lease lookup database/creds/readonly/bartV2mZhIaLO5eFvvqL9UVC

=>SORTIE

Key             Value
---             -----
expire_time     2026-02-17T12:46:37.235137444+01:00
id              database/creds/readonly/bartV2mZhIaLO5eFvvqL9UVC
issue_time      2026-02-17T11:46:37.235137302+01:00
last_renewal    <nil>
renewable       true
ttl             42m33s <========= Lease
```

- 1.11 Renouveler et Revoquer via ID
```
vault lease renew database/creds/readonly/$LEASE_ID
vault lease revoke database/creds/readonly/$LEASE_ID
```

- 1.12 Renouveler et Revoquer via prefix
```
vault lease revoke -prefix database/creds/readonly
```

---

⚠️ `[ATTENTION]` Si on révoque les credentials d'accès à la base de données, on perd la connexion via TCP/IP (pas en Socket Unix).  
Pour recréer des credentials d'accès à PostgreSQL :

```
vault read database/creds/readonly
```

---

## Présentation d'utilisation d'un role `Static` Secret Engine:

- Ici utilisation d'un user de PostGreSQL (déja créé : sednal), Vault ne gére que le password.


- 1.13 Ecriture de l'utilisateur PostGreSQL (ici utilisation de tee + EOF, mais édition via vim ou nano possible)
```
tee static_user.sql <<EOF
ALTER USER "{{name}}" WITH PASSWORD '{{password}}';
EOF
```

- 1.14 Création du rôle dans vault
```
vault write database/static-roles/sednal \
      db_name=postgresql \
      rotation_statements=@/home/sednal/vault-config/db_user/static_user.sql \
      username="sednal" \
      rotation_period=86400
```

- 1.15 Editer le role static 
```
vault read database/static-roles/app

```

`=>` Sortie
```
Key                     Value
---                     -----
credential_type         password
db_name                 postgresql
last_vault_rotation     2026-02-17T12:40:16.672218495+01:00
rotation_period         24h
rotation_statements     [ALTER USER "{{name}}" WITH PASSWORD '{{password}}';]
skip_import_rotation    false
username                sednal
```

- 1.16 Voir le Password
```
vault read database/static-creds/sednal
```

- Sortie
```
Key                    Value
---                    -----
last_vault_rotation    2026-02-17T12:40:16.672218495+01:00
password               5a7olXIIutxO3ai3z-5W
rotation_period        24h
ttl                    23h52m32s
username               sednal
```

- 1.17 Test Accés PostGreSQL, avec le nouveau Password
```
sednal@VaultTraining:~$ psql -h localhost -U sednal -W postgres

Mot de passe :

psql (18.2 (Debian 18.2-1.pgdg13+1))
Connexion SSL (protocole : TLSv1.3, chiffrement : TLS_AES_256_GCM_SHA384, compression : désactivé, ALPN : postgresql)
Saisissez « help » pour l'aide.

postgres=> <========= ICI connection OK 
```
---
---




### -2. **PKI**

- 
```

```


-
```

```

-
```

```



-
```

```



-
```

```

### -3. SSH
---
---

### **COMMANDES**


``


-Sortie


---


``


-Sortie


---

``


-Sortie


---

``


-Sortie


---

``


-Sortie


---

``


-Sortie


---


 [CHOSES A RETENIR]
